# 2022-06-11

解决会话与用户细查展现不一致问题

会话分析从数据库得到的结果

```sql
SELECT
        sessionId,userId,
       startTime 
                FROM
                        session
                WHERE
                        appIndex=727
                AND     startTime BETWEEN toDateTime('2022-06-10 00:00:00') AND     toDateTime('2022-06-10 23:59:59')
                
                
sessionId       |userId      |startTime              |
----------------+------------+-----------------------+
427b0e7a014e4612|test 00093  |2022-06-10 11:38:52.000|
bc9b2605e6364056|test 00093  |2022-06-10 11:54:14.000|
8c0f3ddf9c1c4b70|test 00093  |2022-06-10 15:13:00.000|
1ba2513fcdad4919|test 00093  |2022-06-10 15:22:38.000|
7aa84196f5384f9c|test35621495|2022-06-10 16:59:14.000|
2f818d83aeed4c61|test35621495|2022-06-10 17:00:19.000|
a4867556bce545f3|test999999  |2022-06-10 17:01:11.000|           
```



```sql
SELECT
                        sessionId,
                        any(startTime) AS st
                FROM
                        session
                WHERE
                        appIndex=727
                AND     startTime BETWEEN toDateTime('2022-06-10 00:00:00') AND     toDateTime('2022-06-10 23:59:59')
                GROUP BY
                        sessionId 

sessionId       |st                     |
----------------+-----------------------+
1ba2513fcdad4919|2022-06-10 15:22:38.000|
8c0f3ddf9c1c4b70|2022-06-10 15:13:00.000|
bc9b2605e6364056|2022-06-10 11:54:14.000|
a4867556bce545f3|2022-06-10 17:01:11.000|
7aa84196f5384f9c|2022-06-10 16:59:14.000|
2f818d83aeed4c61|2022-06-10 17:00:19.000|
427b0e7a014e4612|2022-06-10 11:38:52.000|
```

# 2022-06-13

Added
新增用户属性分析

Changed
维度数字区间新增左闭右开区间

Fixed
修复数据库字段null值无返回



# 2022-06-14

### 统一下载接口疑难问题

如何设计接口，接收各种各样的请求？   ----body为String，通过反序列化成各种对象

如果高级分析需要多个SQL才能获取到最终结果怎么办？ 

- 如果可以通过一个SQL获取到页面展示的数据，则通过SQL拦截进行获取，

- 如果不能，需要通过拦截方法或者





```
body接收String
通过query参数进行反序列化
对反序列化对象进行处理
将反序列化对象插入到队列中
通过队列监听，监听是否有下载任务
调用不同的Service进行高级分析的底层查询操作
通过拦截器拦截到执行SQL
通过HTTP调用CK

```



```
{
    "timeUnit": 2,
    "timeUnitSpan": 3,
    "date": [
        "2022-06-07 00:00:00",
        "2022-06-13 23:59:59"
    ],
    "indicators": [
        {
            "eventId": "$ae_app_open",
            "isVirtual": false,
            "eventName": "打开应用",
            "relationType": 1,
            "filters": []
        },
        {
            "eventId": "$ae_session",
            "isVirtual": false,
            "eventName": "离开应用",
            "relationType": 1,
            "filters": []
        }
    ],
    "global": {
        "relationType": 1,
        "filters": []
    }
}
```





```http
curl -vsS "http://localhost:8123/?enable_http_compression=1" \
    -H 'Accept-Encoding: gzip' --output result.gz -d 'SELECT number FROM system.numbers LIMIT 3'
```



```
curl -vsS "http://localhost:8123/?enable_http_compression=1" \
    -H 'Accept-Encoding: gzip' --output result.gz -d 'SELECT number FROM system.numbers LIMIT 3 FORMAT CSVWithNames'
```



```
curl -vsS "http://localhost:8123/?enable_http_compression=1" \
    -H 'Accept-Encoding: gzip' --output output.csv.gz -d 'SELECT number FROM system.numbers LIMIT 3 FORMAT CSVWithNames'
```

压缩文件中，结果保存为output.csv文件



```
curl -sS 'http://localhost:8123/?max_result_bytes=5000000&buffer_size=3000000&wait_end_of_query=1' -d 'SELECT toUInt8(number) FROM system.numbers LIMIT 9000000 FORMAT CSV'
```

```
$ curl -sS 'http://localhost:8123/?max_result_bytes=4000000&buffer_size=3000000&wait_end_of_query=1' -d 'SELECT toUInt8(number) FROM system.numbers LIMIT 9000000 FORMAT RowBinary'
```



```
漏斗分析 2个SQL
间隔分析 按总体，按日期，按维度 3SQL
```

### 为什么要通过Kafka，而不通过dubbo去做下载

1. 通过dubbo调用会有超时问题，下载数据量如果过大容易出现超时

为什么通过HTTP连接去做下载

1. 下载数据量过大的时候，容易出现超时
